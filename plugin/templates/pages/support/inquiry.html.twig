{% import 'components/form/fields_macros.html.twig' as fields %}
{% import '@iservice/components/fields_macros.html.twig' as fieldsIservice %}

{% set params  = params ?? [] %}
{% set no_header = no_header|default(not item.isNewItem() and not _get._in_modal|default(false)) %}
{% set bg = '' %}
{% if item.isDeleted() %}
    {% set bg = 'asset-deleted' %}
{% endif %}

<div class="asset {{ bg }}">
    {{ include('components/form/header.html.twig', {'in_twig': true}) }}

    {% set params  = params ?? [] %}
    {% set withtemplate = params['withtemplate'] ?? '' %}
    {% set item_type = item.getType() %}
    {% set field_options = {
        'locked_fields': item.getLockedFields(),
        'full_width': true,
    } %}

    <div class="card-body d-flex flex-wrap">
        <div class="col-12 col-xxl-10 flex-column">
            <div class="d-flex flex-row flex-wrap flex-xl-nowrap">
                <div class="row flex-row align-items-start flex-grow-1">
                    <div class="row flex-row">
                        {% block form_fields %}
                            {{ fields.dropdownField(
                                'Supplier',
                                'suppliers_id',
                                partnerId,
                                __('Partener'),
                                field_options|merge({
                                    'on_change': "$(this).closest('form').submit();",
                                    'disabled': partnersFieldDisabled
                                })
                            ) }}

                            {{ fields.dropdownField(
                                'Printer',
                                'printer_id',
                                printerId,
                                'Printer'|itemtype_name,
                                field_options|merge({
                                    'condition': {
                                        'LEFT JOIN': {
                                            'glpi_infocoms as i': {
                                                'ON': {
                                                    'i': 'items_id',
                                                    'glpi_printers': 'id'
                                                }
                                            }
                                        },
                                        'WHERE': {
                                            'i.suppliers_id': partnerId,
                                        }
                                    },
                                    'on_change': "$(this).closest('form').submit();",
                                    'disabled': printersFieldDisabled
                                })
                            ) }}

                            {% if usageAddressField %}
                                {{ fields.textField(
                                    'printer[usage_address_field]',
                                    usageAddressField,
                                    __('Usage Address', 'iservice'),
                                    field_options|merge({
                                        'disabled': true,
                                    })
                                ) }}
                            {% endif %}

                            {% if locationName %}
                                {{ fields.textField(
                                    'printer[locationName]',
                                    locationName,
                                    __('Location'),
                                    field_options|merge({
                                        'disabled': true,
                                    })
                                ) }}
                            {% endif %}

                            {% if locationId %}
                                {{ fields.textField(
                                    'locations_id',
                                    locationId,
                                    '',
                                    field_options|merge({
                                        'type': 'hidden',
                                    })
                                ) }}
                            {% endif %}

                            {% if sumOfUnpaidInvoicesLink %}
                                {{ fieldsIservice.formLink(
                                    __('Sum of unpaid invoices', 'iservice'),
                                    sumOfUnpaidInvoicesLink
                                ) }}
                            {% endif %}

                            {{ fields.textField(
                                'name',
                                item.fields['name'],
                                __('Title'),
                                field_options|merge({
                                    'required': true,
                                })
                            ) }}

                            {{ fields.textareaField(
                                'content',
                                item.fields['content'],
                                __('Content'),
                                field_options|merge({
                                    'enable_richtext': 0,
                                })
                            ) }}

                        {% endblock %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{ include('components/form/buttons.html.twig') }}
</div>

